# CAP定理

分散システムにおいて、以下の3つのうち満たすことができるのは最大2つという定理。
Eric Brewer が[予想][1]し、Seth Gilbert, Nacny Lynch が[証明][2]した。  
Eric Brewer 自身が2012年に [The "2 of 3" formulation was always misleading ][6] と言っていることに注意。

### Consistency (一貫性)

全ノードで同時に同じデータが見えること。

### Availability (可用性)

死亡(ダウン)していない生存中のノードが常に応答を反すこと。  
これを実現するには、**単一点障害** が無いことが必要。

### Partition tolerance (分断耐性)

NP (Network Partitin = ネットワーク分断) 状態でも継続して動作を行うこと。  
NP状態で片方を切り捨てる場合、分断耐性が無い。

# CAP定理から見た Database

DBのACID性を支える仕組みに 2PC(2フェーズコミット)、 3PC(3フェーズコミット) があるが、
Henry Robinson による [Paxos (分散合意アルゴリズム) の説明][3] を借りると、

- 2PC は シングルノードの障害が処理をブロックするという単一点障害があり、可用性が犠牲になる。
- 3PC は 単一点障害を克服したが、「NP状態になり、双方で異なる更新が行われた後、NP状態が解消したとき」 に、一貫性が犠牲になる。

NoSQL系 DB は、可用性と分断耐性を保障して、一貫性を弱める
(*Eventual Consistency* = 結果一貫性 という弱い一貫性モデルを用いる)
デザインになっている。

# CAP定理から見た HA cluster

一貫性、可用性、分断耐性のうち、共有ディスク型クラスタとデータミラー型クラスタでは、満たすものが異なる。

以下 C = 一貫性、 A=可用性、 P=分断耐性 とする。

## 共有ディスク型クラスタ

- 共有ディスクの存在によって C を満たす。
- フェイルオーバーの仕組みによって A を満たす。
- NP状態になったら、一貫性を維持するために 何れか一方のノード群(一般的にはノード数が少ない方)をダウンさせるので、**P を満たさない。**

## データミラー型クラスタ

- NP状態や、ノードダウン、遅延が起こると、あるノードだけがデータ更新を行う状態になりうるため、ノードによって見えるデータが異なる状態になり、**C を満たさない**。
- フェイルオーバの仕組みによって A を満たす。
- NP状態でも動作を継続する場合は Pを満たす。

- NP状態への対処として何れかのノードを止める場合は上記 C に加え **P も満たさない**。

## データミラー型クラスタが結果一貫性を満たすケース
上で データミラー型クラスタが C を満たさない事を示したが、これは **強い一貫性** を満たさないことを意味している。
しかし、何れかの時点で一貫性を回復することは可能で、この場合 **弱い一貫性** (結果一貫性) を満たす。
以下にデータミラー型クラスタが **結果一貫性** を満たす場合を示す。  
HAクラスタといえども DB同様、NP によって一貫性を一時的に失うことは注意すべきだろう。

1. 初期状態では node1 が現用系、node2 が待機系で、node1 から node2 へレプリケーションを行っている。

2. node1 が遅延状態 若しくは NP状態へ突入し、NP対処処理が始まる。

3. node3 (例: Gateway server や Witness node) と通信不能なノードは自殺し、通信可能なノードが生き残る。自殺ノードが持つデータは更新されなくなり、生存ノードの持つデータは更新され、**一貫性を失う**。

4. NP状態の原因となった故障を修復したら、自殺ノードを起動する。

5. 生存ノードのデータで自殺ノードのデータを上書きすることで **一貫性を取り戻す**。


# 分散合意アルゴリズム イントロ

遅延による影響を克服可能なアルゴリズムとして登場したのが Paxos。 Paxosの課題は

- シンプルで数学的に検証されているが、実用には拡張が必要で、拡張実装の動作の正しさが不明。
- 理解しにくい。

であるとして、Paxosに代わるものとして提案されているのが [Raft][5]

# 課題
- HAクラスタソフトが採用している[一環性モデル][4]を分類せよ。

- CAP定理に基づき HAクラスタソフトの強化を考察せよ。
	- 一貫性を弱める   : 一貫性を弱める方法に「結果一貫性」を用いる以外の方法は無いだろうか。
	- 可用性を弱める   : 可用性を弱めた HAクラスタを考察せよ。
		-  障害が発生してからフェイルオーバが完了するまでの間 サービスは止まる。したがって、ミクロに見れば、実はHAクラスタといえども A を満たしていない (弱めている)。
		- 「単一点障害の存在を許すHAクラスタ」とはどのようなものだろうか。
			- 単一点障害が発生するとシステムが提供するサービスが止まるため A が満たされず 、従って HAクラスタとして成立しない。
	- 分断耐性を弱める : 「強い一貫性と可用性を満たすトラディショナルなHAクラスタ」に対して「分断体制の弱め方」にどのような方式がありえるだろうか。

- HAクラスタは の工夫のしどころは、如何に C と A を満たすか、また、如何に P を弱めるか、に尽きる。


[1]: http://www.cs.berkeley.edu/~brewer/cs262b-2004/PODC-keynote.pdf
[2]: http://lpd.epfl.ch/sgilbert/pubs/BrewersConjecture-SigAct.pdf
[3]: http://the-paper-trail.org/blog/consensus-protocols-paxos/
[4]: http://ossforum.jp/node/840
[5]: https://ramcloud.stanford.edu/wiki/download/attachments/11370504/raft.pdf
[6]: http://www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-changed
