# CAP定理

分散システムにおいて、以下の3つのうち満たすことができるのは最大2つという定理。
Eric Brewer が[予想][1]し、Seth Gilbert, Nacny Lynch が[証明][2]した。  
Eric Brewer 自身が2012年に [The "2 of 3" formulation was always misleading ][6] と言っていることに注意。

## Consistency (一貫性)

全ノードで同時に同じデータが見えること。

## Availability (可用性)

死亡(ダウン)していない生存中のノードが常に応答を反すこと。  
これを実現するには、**単一点障害** が無いことが必要。

## Partition tolerance (分断耐性)

NP(Network Partitin = ネットワーク分断)状態でも継続して動作を行うこと。  
NP状態で片方を切り捨てる場合、分断耐性が無い。

# CAP定理から見た Database

DBのACID性を支える仕組みに 2PC(2フェーズコミット)、 3PC(3フェーズコミット) があるが、
Henry Robinson による [Paxos (分散合意アルゴリズム) の説明][3] を借りると、

- 2PC は単一店障害があり、可用性が犠牲になる。
- 3PC は単一店障を克服したが、一貫性が犠牲になる。

3PCでは **「遅延によるNP状態」** から復帰したときに一貫性を失う。

NoSQL系 DB は、可用性と分断耐性を保障して、[一貫性][4] を弱める
(*Eventual Consistency* = 結果一貫性 という弱い一貫性モデルを用いる)
というデザインになっている。

# CAP定理から見た HA cluster

一貫性、可用性、分断耐性のうち、共有ディスク型クラスタとデータミラー型クラスタでは、満たすものが異なる。

以下 C = 一貫性、 A=可用性、 P=分断耐性 とする。

## 共有ディスク型クラスタ

- 共有ディスクの存在によって C を満たす。
- フェイルオーバーの仕組みによって A を満たす。
- NP状態になったら、一貫性を維持するために 何れか一方のノード群(一般的にはノード数が少ない方)をダウンさせるので、**P を満たさない。**

## データミラー型クラスタ

- NP状態や、ノードダウン、遅延が起こると、あるノードだけがデータ更新を行う状態になりうるため、ノードによって見えるデータが異なる状態になり、**C を満たさない**。
- フェイルオーバの仕組みによって A を満たす。
- NP状態でも動作を継続する場合は、Pを満たす。

- NP対処処理で何れかのノードを止める場合は上記Cに加え **P も満たさない**。

## データミラー型クラスタが結果一貫性を満たすケース
上では データミラー型クラスタが C を満たさない事を示したが、
これは強い一貫性を満たさないことを意味している。
しかし、何れかの時点で一貫性を回復することは可能であり、
この場合、**結果一貫性** を満たす。

以下にデータミラー型クラスタが弱い一貫性 (結果一貫性) を満たす場合を示す。  
HAクラスタといえども DB同様、NP によって一貫性を(一時的に)失いうることに注意。

1. 初期状態ではnode1 でサービスが稼動し、node2が待機していて、node1 から node2 へミラーを行っている。

2. node1で遅延若しくはNP状態へ突入し、NP解決処理が始まる。第三のIPアドレス(eg. Gateway アドレス)と通信不能なノードは自殺し、通信可能なノードが生き残る。
自殺したノードが持っていたデータは更新されなくなり、生存したノードの持つデータは更新され、**一貫性を失う**。

3. NP状態が解消したら、自殺ノードを起動する。

4. 生存ノードのデータで自殺ノードのデータを上書きすることで **一貫性を取り戻す**。


# 分散合意アルゴリズム イントロ

遅延による影響を克服しうるアルゴリズムとして登場したのが Paxos。 Paxosの課題は

- シンプルで数学的に検証されているが、実用には拡張が必要で、拡張実装の動作の正しさが不明。
- 理解しにくい。

であるとして、Paxosに代わるものとして提案されているのが [Raft][5]

# 課題
- HAクラスタソフトが採用している一環性モデルを分類せよ。

- CAP定理に基づき HAクラスタソフトの強化を考察せよ。

	- 一貫性を弱める   : 一貫性を弱める方法に「結果一貫性」以外の方法はありえるだろうか。
	- 可用性を弱める   : 可用性そ弱めた HAクラスタを考察せよ。「単一点障害の存在を許すHAクラスタ」とはどのようなものだろうか。
	- 分断耐性を弱める : 「強い一貫性と可用性を満たすトラディショナルなHAクラスタ」に対して「分断体制の弱め方」にどのような方式がありえるだろうか。


[1]: http://www.cs.berkeley.edu/~brewer/cs262b-2004/PODC-keynote.pdf
[2]: http://lpd.epfl.ch/sgilbert/pubs/BrewersConjecture-SigAct.pdf
[3]: http://the-paper-trail.org/blog/consensus-protocols-paxos/
[4]: http://ossforum.jp/node/840
[5]: https://ramcloud.stanford.edu/wiki/download/attachments/11370504/raft.pdf
[6]: http://www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-changed
